<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commitment Contract</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #0a0a0a;
            color: #e0e0e0;
        }
        h1, h2 {
            color: #fff;
        }
        .card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        label {
            display: block;
            margin: 10px 0 5px;
            font-weight: 500;
        }
        input, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 4px;
            background: #0a0a0a;
            color: #fff;
            font-size: 14px;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: #646cff;
        }
        button {
            background: #646cff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 15px;
        }
        button:hover {
            background: #747bff;
        }
        button:disabled {
            background: #444;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .status.success {
            background: #1a3a1a;
            border: 1px solid #2d5a2d;
        }
        .status.error {
            background: #3a1a1a;
            border: 1px solid #5a2d2d;
        }
        .status.info {
            background: #1a1a3a;
            border: 1px solid #2d2d5a;
        }
        .hash-preview {
            font-family: monospace;
            font-size: 12px;
            color: #888;
            word-break: break-all;
            margin-top: 5px;
        }
        .small {
            font-size: 12px;
            color: #888;
        }
        #connectionStatus {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 12px;
        }
        .connected {
            background: #1a3a1a;
            color: #4ade80;
        }
        .disconnected {
            background: #3a1a1a;
            color: #f87171;
        }
    </style>
</head>
<body>
    <div id="connectionStatus" class="disconnected">Not Connected</div>
    
    <h1>üîí Commitment Contract</h1>
    <p>Create binding commitments with financial stakes. Funds are released only if both you and your accountability partner agree you completed the commitment.</p>
    
    <div class="card">
        <h2>1. Connect Wallet</h2>
        <p class="small">Connect your wallet to Base Sepolia to interact with the contract.</p>
        <button id="connectBtn" onclick="connectWallet()">Connect Wallet</button>
        <div id="connectionInfo"></div>
    </div>

    <div class="card">
        <h2>2. Create Commitment</h2>
        
        <label>Your Commitment:</label>
        <textarea id="commitmentText" rows="3" placeholder="I will ship my project by February 28th, 2026" oninput="updateHash()"></textarea>
        <div class="hash-preview">Hash: <span id="hashPreview">-</span></div>
        
        <label>Partner's Wallet Address:</label>
        <input type="text" id="partnerAddress" placeholder="0x...">
        
        <label>Deadline:</label>
        <input type="datetime-local" id="deadline">
        
        <label>Stake Amount (ETH):</label>
        <input type="number" id="stakeAmount" step="0.001" value="0.01" placeholder="0.1">
        
        <button id="createBtn" onclick="createCommitment()" disabled>Create Commitment</button>
        <div id="createStatus"></div>
    </div>

    <div class="card">
        <h2>3. Manage Commitment</h2>
        
        <label>Commitment ID:</label>
        <input type="number" id="commitmentId" placeholder="0">
        <button onclick="loadCommitment()">Load</button>
        
        <div id="commitmentDetails" style="margin-top: 15px;"></div>
        
        <button id="signBtn" onclick="signForRelease()" disabled>Sign for Release</button>
        <div id="manageStatus"></div>
    </div>

    <script>
        // Contract ABI
        const ABI = [
            "function createCommitment(address _partner, uint256 _deadline, bytes32 _commitmentHash) payable returns (uint256)",
            "function signForRelease(uint256 _commitmentId)",
            "function commitments(uint256) view returns (address depositor, address partner, uint256 amount, uint256 deadline, bytes32 commitmentHash, bool depositorSigned, bool partnerSigned, bool released)",
            "function timeRemaining(uint256 _commitmentId) view returns (uint256)",
            "function isLocked(uint256 _commitmentId) view returns (bool)",
            "function nextCommitmentId() view returns (uint256)",
            "event CommitmentCreated(uint256 indexed commitmentId, address indexed depositor, address indexed partner, uint256 amount, uint256 deadline, bytes32 commitmentHash)",
            "event SignedForRelease(uint256 indexed commitmentId, address indexed signer)",
            "event FundsReleased(uint256 indexed commitmentId, address indexed depositor, uint256 amount)"
        ];

        const CONTRACT_ADDRESS = '0x8fc59b7e971A2Bd2AAdF7aaDC2aBB0279fCE7d29';
        let provider, signer, contract;

        async function connectWallet() {
            const walletProvider = window.rabby || window.ethereum;
            if (!walletProvider) {
                alert("No wallet detected. Please install Rabby or MetaMask.");
                return;
            }
            
            try {
                provider = new ethers.BrowserProvider(walletProvider);
                await provider.send("eth_requestAccounts", []);
                signer = await provider.getSigner();
                const address = await signer.getAddress();
                const network = await provider.getNetwork();
                
                const walletName = window.rabby ? 'Rabby' : (walletProvider.isMetaMask ? 'MetaMask' : 'Wallet');
                document.getElementById('connectionStatus').textContent = 
                    `${walletName}: ${address.slice(0,6)}...${address.slice(-4)} (${network.name})`;
                document.getElementById('connectionStatus').className = 'connected';
                
                loadContract();
            } catch (err) {
                console.error(err);
                showStatus('connectionInfo', 'error', err.message);
            }
        }

        function loadContract() {
            contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
            showStatus('connectionInfo', 'success', 'Connected to contract');
            document.getElementById('createBtn').disabled = false;
            document.getElementById('signBtn').disabled = false;
        }

        function updateHash() {
            const text = document.getElementById('commitmentText').value;
            if (text) {
                const hash = ethers.keccak256(ethers.toUtf8Bytes(text));
                document.getElementById('hashPreview').textContent = hash;
            } else {
                document.getElementById('hashPreview').textContent = '-';
            }
        }

        async function createCommitment() {
            try {
                const text = document.getElementById('commitmentText').value;
                const partner = document.getElementById('partnerAddress').value;
                const deadlineInput = document.getElementById('deadline').value;
                const stake = document.getElementById('stakeAmount').value;
                
                if (!text || !partner || !deadlineInput || !stake) {
                    showStatus('createStatus', 'error', 'Please fill all fields');
                    return;
                }
                
                const deadline = Math.floor(new Date(deadlineInput).getTime() / 1000);
                const commitmentHash = ethers.keccak256(ethers.toUtf8Bytes(text));
                
                showStatus('createStatus', 'info', 'Creating commitment...');
                
                const tx = await contract.createCommitment(
                    partner,
                    deadline,
                    commitmentHash,
                    { value: ethers.parseEther(stake) }
                );
                
                showStatus('createStatus', 'info', 'Waiting for confirmation...');
                const receipt = await tx.wait();
                
                // Find the commitment ID from logs
                const iface = new ethers.Interface(ABI);
                for (const log of receipt.logs) {
                    try {
                        const parsed = iface.parseLog(log);
                        if (parsed.name === 'CommitmentCreated') {
                            const id = parsed.args[0];
                            document.getElementById('commitmentId').value = id.toString();
                            showStatus('createStatus', 'success', `Commitment #${id} created! TX: ${receipt.hash}`);
                            return;
                        }
                    } catch {}
                }
                
                showStatus('createStatus', 'success', `Created! TX: ${receipt.hash}`);
            } catch (err) {
                console.error(err);
                showStatus('createStatus', 'error', err.message);
            }
        }

        async function loadCommitment() {
            try {
                const id = document.getElementById('commitmentId').value;
                const c = await contract.commitments(id);
                const timeLeft = await contract.timeRemaining(id);
                const locked = await contract.isLocked(id);
                
                let status;
                if (c.released) {
                    status = '‚úÖ Released';
                } else if (locked) {
                    status = 'üîí Permanently Locked';
                } else {
                    status = '‚è≥ Active';
                }
                
                const details = `
                    <p><strong>Status:</strong> ${status}</p>
                    <p><strong>Depositor:</strong> ${c.depositor}</p>
                    <p><strong>Partner:</strong> ${c.partner}</p>
                    <p><strong>Amount:</strong> ${ethers.formatEther(c.amount)} ETH</p>
                    <p><strong>Deadline:</strong> ${new Date(Number(c.deadline) * 1000).toLocaleString()}</p>
                    <p><strong>Time Remaining:</strong> ${formatTime(Number(timeLeft))}</p>
                    <p><strong>Depositor Signed:</strong> ${c.depositorSigned ? '‚úÖ' : '‚ùå'}</p>
                    <p><strong>Partner Signed:</strong> ${c.partnerSigned ? '‚úÖ' : '‚ùå'}</p>
                `;
                document.getElementById('commitmentDetails').innerHTML = details;
                
                document.getElementById('signBtn').disabled = c.released || locked;
            } catch (err) {
                console.error(err);
                document.getElementById('commitmentDetails').innerHTML = `<p style="color: #f87171;">Error: ${err.message}</p>`;
            }
        }

        async function signForRelease() {
            try {
                const id = document.getElementById('commitmentId').value;
                showStatus('manageStatus', 'info', 'Signing...');
                const tx = await contract.signForRelease(id);
                await tx.wait();
                showStatus('manageStatus', 'success', 'Signed! TX: ' + tx.hash);
                loadCommitment();
            } catch (err) {
                console.error(err);
                showStatus('manageStatus', 'error', err.message);
            }
        }

        function showStatus(elementId, type, message) {
            const el = document.getElementById(elementId);
            el.className = 'status ' + type;
            el.textContent = message;
        }

        function formatTime(seconds) {
            if (seconds <= 0) return 'Expired';
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            return `${days}d ${hours}h ${mins}m`;
        }

        // Set default deadline to 30 days from now
        const defaultDeadline = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000);
        document.getElementById('deadline').value = defaultDeadline.toISOString().slice(0, 16);
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.9.0/ethers.umd.min.js"></script>
</body>
</html>