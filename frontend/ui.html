<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commitment Contract</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 12px;
            margin: 0;
            padding: 12px;
            background: #fff;
            color: #222;
        }
        h1 {
            font-size: 16px;
            margin: 0 0 4px 0;
        }
        h2 {
            font-size: 13px;
            margin: 0 0 6px 0;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: flex-start;
        }
        .card {
            background: #fafafa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            flex: 1;
            min-width: 220px;
        }
        label {
            display: inline-block;
            margin: 4px 8px 2px 0;
            font-weight: 500;
        }
        input, textarea {
            padding: 4px 6px;
            border: 1px solid #ccc;
            border-radius: 3px;
            background: #fff;
            color: #222;
            font-size: 11px;
            margin-right: 6px;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: #646cff;
        }
        textarea {
            width: 100%;
        }
        button {
            background: #646cff;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            margin: 4px 4px 4px 0;
        }
        button:hover {
            background: #747bff;
        }
        button:disabled {
            background: #aaa;
            cursor: not-allowed;
        }
        .status {
            padding: 4px 8px;
            border-radius: 3px;
            margin-top: 4px;
            font-size: 11px;
        }
        .status.success {
            background: #d4edda;
            border: 1px solid #a3d9a5;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .status.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .hash-preview {
            font-family: monospace;
            font-size: 10px;
            color: #666;
            word-break: break-all;
            margin-top: 2px;
        }
        .small {
            font-size: 10px;
            color: #666;
        }
        #connectionStatus {
            position: fixed;
            top: 6px;
            right: 6px;
            padding: 4px 10px;
            border-radius: 3px;
            font-size: 10px;
        }
        .connected {
            background: #d4edda;
            color: #155724;
        }
        .disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        .commitment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 3px;
            margin: 4px 0;
            cursor: pointer;
            transition: border-color 0.2s;
            font-size: 11px;
        }
        .commitment-item:hover {
            border-color: #646cff;
        }
        .commitment-item .role {
            font-size: 9px;
            padding: 1px 5px;
            border-radius: 2px;
            text-transform: uppercase;
        }
        .commitment-item .role.depositor {
            background: #d4edda;
            color: #155724;
        }
        .commitment-item .role.partner {
            background: #d1ecf1;
            color: #0c5460;
        }
        .no-commitments {
            color: #888;
            font-style: italic;
        }
        #commitmentDetails p {
            margin: 2px 0;
        }
        .details-hero {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 8px;
        }
        .details-status {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
        }
        .details-commitment {
            font-size: 13px;
            font-weight: 500;
            color: #111;
            background: #fff;
            border-left: 3px solid #646cff;
            padding: 8px 10px;
            margin: 8px 0;
            word-break: break-word;
        }
        .details-value {
            font-size: 16px;
            font-weight: 700;
            color: #111;
        }
        .details-value .usd {
            font-size: 12px;
            font-weight: 400;
            color: #666;
            margin-left: 6px;
        }
        .details-deadline {
            display: inline-block;
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 500;
            margin-top: 6px;
        }
        .details-deadline.expired {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .details-meta {
            font-size: 10px;
            color: #666;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #eee;
        }
        .details-meta p {
            margin: 3px 0;
        }
        .details-signatures {
            display: flex;
            gap: 12px;
            margin-top: 6px;
        }
        .details-signatures span {
            font-size: 11px;
        }
        .header {
            margin-bottom: 8px;
        }
        .header p {
            margin: 0;
            font-size: 11px;
            color: #555;
        }
    </style>
</head>
<body>
    <div id="connectionStatus" class="disconnected">Not Connected</div>
    
    <div class="header">
        <h1>üîí Commitment Contract</h1>
        <p>Binding commitments with financial stakes. Funds released when both parties sign.</p>
    </div>
    
    <div class="container">
        <div class="card">
            <h2>Connect</h2>
            <button id="connectBtn" onclick="connectWallet()">Connect Wallet</button>
            <div id="connectionInfo"></div>
        </div>

        <div class="card" id="yourCommitmentsCard" style="display: none;">
            <h2>Your Commitments</h2>
            <div id="yourCommitmentsList"></div>
        </div>

        <div class="card">
            <h2>Create</h2>
            <textarea id="commitmentText" rows="2" placeholder="I will ship my project by Feb 28th" oninput="updateHash()"></textarea>
            <div class="hash-preview">Hash: <span id="hashPreview">-</span></div>
            <div>
                <label>Partner:</label><input type="text" id="partnerAddress" placeholder="0x..." style="width:140px;">
                <label>Deadline:</label><input type="datetime-local" id="deadline" style="width:150px;">
                <label>ETH:</label><input type="number" id="stakeAmount" step="0.001" value="0.01" style="width:70px;">
            </div>
            <button id="createBtn" onclick="createCommitment()" disabled>Create</button>
            <div id="createStatus"></div>
        </div>

        <div class="card">
            <h2>Manage</h2>
            <label>ID:</label><input type="number" id="commitmentId" placeholder="0" style="width:50px;">
            <button onclick="loadCommitment()">Load</button>
            <button id="signBtn" onclick="signForRelease()" disabled>Sign</button>
            <div id="commitmentDetails" style="margin-top: 6px;"></div>
            <div id="manageStatus"></div>
        </div>
    </div>

    <script>
        // Contract ABI
        const ABI = [
            "function createCommitment(address _partner, uint256 _deadline, bytes32 _commitmentHash) payable returns (uint256)",
            "function signForRelease(uint256 _commitmentId)",
            "function commitments(uint256) view returns (address depositor, address partner, uint256 amount, uint256 deadline, bytes32 commitmentHash, bool depositorSigned, bool partnerSigned, bool released)",
            "function timeRemaining(uint256 _commitmentId) view returns (uint256)",
            "function isLocked(uint256 _commitmentId) view returns (bool)",
            "function nextCommitmentId() view returns (uint256)",
            "event CommitmentCreated(uint256 indexed commitmentId, address indexed depositor, address indexed partner, uint256 amount, uint256 deadline, bytes32 commitmentHash)",
            "event SignedForRelease(uint256 indexed commitmentId, address indexed signer)",
            "event FundsReleased(uint256 indexed commitmentId, address indexed depositor, uint256 amount)"
        ];

        const CONTRACT_ADDRESS = '0x8fc59b7e971A2Bd2AAdF7aaDC2aBB0279fCE7d29';
        const API_URL = 'http://localhost:3001';
        let provider, signer, contract;
        let ethPrice = null;
        
        (async function fetchEthPrice() {
            try {
                const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd');
                const data = await res.json();
                ethPrice = data.ethereum.usd;
            } catch (e) { console.warn('Failed to fetch ETH price:', e); }
        })();

        async function connectWallet() {
            const walletProvider = window.rabby || window.ethereum;
            if (!walletProvider) {
                alert("No wallet detected. Please install Rabby or MetaMask.");
                return;
            }
            
            try {
                provider = new ethers.BrowserProvider(walletProvider);
                await provider.send("eth_requestAccounts", []);
                signer = await provider.getSigner();
                const address = await signer.getAddress();
                const network = await provider.getNetwork();
                
                const walletName = window.rabby ? 'Rabby' : (walletProvider.isMetaMask ? 'MetaMask' : 'Wallet');
                document.getElementById('connectionStatus').textContent = 
                    `${walletName}: ${address.slice(0,6)}...${address.slice(-4)} (${network.name})`;
                document.getElementById('connectionStatus').className = 'connected';
                
                loadContract();
            } catch (err) {
                console.error(err);
                showStatus('connectionInfo', 'error', err.message);
            }
        }

        function loadContract() {
            contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
            showStatus('connectionInfo', 'success', 'Connected to contract');
            document.getElementById('createBtn').disabled = false;
            document.getElementById('signBtn').disabled = false;
            loadUserCommitments();
        }

        async function loadUserCommitments() {
            const userAddress = (await signer.getAddress()).toLowerCase();
            const card = document.getElementById('yourCommitmentsCard');
            const list = document.getElementById('yourCommitmentsList');
            
            card.style.display = 'block';
            list.innerHTML = '<span class="small">Loading...</span>';
            
            try {
                // Iterate through all commitments (avoids eth_getLogs which public RPCs throttle)
                const totalCommitments = Number(await contract.nextCommitmentId());
                const userCommitments = [];
                
                for (let id = 0; id < totalCommitments; id++) {
                    const c = await contract.commitments(id);
                    const depositor = c.depositor.toLowerCase();
                    const partner = c.partner.toLowerCase();
                    
                    if (depositor === userAddress) {
                        userCommitments.push({ id, commitment: c, role: 'depositor' });
                    } else if (partner === userAddress) {
                        userCommitments.push({ id, commitment: c, role: 'partner' });
                    }
                }
                
                if (userCommitments.length === 0) {
                    list.innerHTML = '<p class="no-commitments">No commitments found</p>';
                    return;
                }
                
                // Build the list
                let html = '';
                for (const { id, commitment: c, role } of userCommitments) {
                    const locked = await contract.isLocked(id);
                    
                    let statusIcon;
                    if (c.released) statusIcon = '‚úÖ';
                    else if (locked) statusIcon = 'üîí';
                    else statusIcon = '‚è≥';
                    
                    const amount = ethers.formatEther(c.amount);
                    const usdValue = ethPrice ? ` ($${(parseFloat(amount) * ethPrice).toFixed(2)})` : '';
                    const deadline = new Date(Number(c.deadline) * 1000).toLocaleDateString();
                    
                    html += `
                        <div class="commitment-item" onclick="selectCommitment(${id})">
                            <div>
                                <strong>#${id}</strong> ${statusIcon}
                                <span class="small" style="margin-left: 8px;">${amount} ETH${usdValue} ¬∑ Due ${deadline}</span>
                            </div>
                            <span class="role ${role}">${role}</span>
                        </div>
                    `;
                }
                list.innerHTML = html;
            } catch (err) {
                console.error(err);
                list.innerHTML = `<p style="color: #f87171;">Error loading commitments: ${err.message}</p>`;
            }
        }

        function selectCommitment(id) {
            document.getElementById('commitmentId').value = id;
            loadCommitment();
            document.getElementById('commitmentId').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function updateHash() {
            const text = document.getElementById('commitmentText').value;
            if (text) {
                const hash = ethers.keccak256(ethers.toUtf8Bytes(text));
                document.getElementById('hashPreview').textContent = hash;
            } else {
                document.getElementById('hashPreview').textContent = '-';
            }
        }

        async function createCommitment() {
            try {
                const text = document.getElementById('commitmentText').value;
                const partner = document.getElementById('partnerAddress').value;
                const deadlineInput = document.getElementById('deadline').value;
                const stake = document.getElementById('stakeAmount').value;
                
                if (!text || !partner || !deadlineInput || !stake) {
                    showStatus('createStatus', 'error', 'Please fill all fields');
                    return;
                }
                
                const deadline = Math.floor(new Date(deadlineInput).getTime() / 1000);
                const commitmentHash = ethers.keccak256(ethers.toUtf8Bytes(text));
                
                showStatus('createStatus', 'info', 'Creating commitment...');
                
                const tx = await contract.createCommitment(
                    partner,
                    deadline,
                    commitmentHash,
                    { value: ethers.parseEther(stake) }
                );
                
                showStatus('createStatus', 'info', 'Waiting for confirmation...');
                const receipt = await tx.wait();
                
                // Find the commitment ID from logs
                const iface = new ethers.Interface(ABI);
                for (const log of receipt.logs) {
                    try {
                        const parsed = iface.parseLog(log);
                        if (parsed.name === 'CommitmentCreated') {
                            const id = parsed.args[0];
                            document.getElementById('commitmentId').value = id.toString();
                            // Save message text to server
                            try {
                                await fetch(`${API_URL}/api/message/${id}`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ text, expectedHash: commitmentHash })
                                });
                            } catch (e) { console.warn('Failed to save message:', e); }
                            showStatus('createStatus', 'success', `Commitment #${id} created! TX: ${receipt.hash}`);
                            loadUserCommitments();
                            return;
                        }
                    } catch {}
                }
                
                showStatus('createStatus', 'success', `Created! TX: ${receipt.hash}`);
            } catch (err) {
                console.error(err);
                showStatus('createStatus', 'error', err.message);
            }
        }

        async function loadCommitment() {
            try {
                const id = document.getElementById('commitmentId').value;
                const c = await contract.commitments(id);
                const timeLeft = await contract.timeRemaining(id);
                const locked = await contract.isLocked(id);
                
                // Fetch stored message text
                let messageText = null;
                try {
                    const res = await fetch(`${API_URL}/api/message/${id}`);
                    const data = await res.json();
                    messageText = data.text;
                } catch (e) { console.warn('Failed to fetch message:', e); }
                
                let status, statusEmoji;
                if (c.released) {
                    status = 'Released';
                    statusEmoji = '‚úÖ';
                } else if (locked) {
                    status = 'Permanently Locked';
                    statusEmoji = 'üîí';
                } else {
                    status = 'Active';
                    statusEmoji = '‚è≥';
                }
                
                const ethAmount = ethers.formatEther(c.amount);
                const usdValue = ethPrice ? `‚âà $${(parseFloat(ethAmount) * ethPrice).toFixed(2)}` : '';
                
                const deadlineDate = new Date(Number(c.deadline) * 1000);
                const isExpired = Number(timeLeft) <= 0;
                const deadlineClass = isExpired ? 'details-deadline expired' : 'details-deadline';
                const timeRemainingText = isExpired ? 'EXPIRED' : formatTime(Number(timeLeft));
                
                const details = `
                    <div class="details-hero">
                        <div class="details-status">${statusEmoji} ${status}</div>
                        ${messageText ? `<div class="details-commitment">${messageText}</div>` : ''}
                        <div class="details-value">${ethAmount} ETH<span class="usd">${usdValue}</span></div>
                        <div class="${deadlineClass}">
                            üìÖ ${deadlineDate.toLocaleDateString()} ${deadlineDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} ¬∑ ${timeRemainingText}
                        </div>
                        <div class="details-signatures">
                            <span>Depositor: ${c.depositorSigned ? '‚úÖ' : '‚ùå'}</span>
                            <span>Partner: ${c.partnerSigned ? '‚úÖ' : '‚ùå'}</span>
                        </div>
                    </div>
                    <div class="details-meta">
                        <p><strong>Depositor:</strong> ${c.depositor}</p>
                        <p><strong>Partner:</strong> ${c.partner}</p>
                        <p><strong>Hash:</strong> <span class="hash-preview">${c.commitmentHash}</span></p>
                    </div>
                `;
                document.getElementById('commitmentDetails').innerHTML = details;
                
                document.getElementById('signBtn').disabled = c.released || locked;
            } catch (err) {
                console.error(err);
                document.getElementById('commitmentDetails').innerHTML = `<p style="color: #721c24;">Error: ${err.message}</p>`;
            }
        }

        async function signForRelease() {
            try {
                const id = document.getElementById('commitmentId').value;
                showStatus('manageStatus', 'info', 'Signing...');
                const tx = await contract.signForRelease(id);
                await tx.wait();
                showStatus('manageStatus', 'success', 'Signed! TX: ' + tx.hash);
                loadCommitment();
            } catch (err) {
                console.error(err);
                showStatus('manageStatus', 'error', err.message);
            }
        }

        function showStatus(elementId, type, message) {
            const el = document.getElementById(elementId);
            el.className = 'status ' + type;
            el.textContent = message;
        }

        function formatTime(seconds) {
            if (seconds <= 0) return 'Expired';
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            return `${days}d ${hours}h ${mins}m`;
        }

        // Set default deadline to 30 days from now
        const defaultDeadline = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000);
        document.getElementById('deadline').value = defaultDeadline.toISOString().slice(0, 16);
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.9.0/ethers.umd.min.js"></script>
</body>
</html>